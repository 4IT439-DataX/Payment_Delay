---
title: "Documentation"
author: "Lenka Stastna, Ivana Stanova"
date: "19 11 2020"
output:
  bookdown::html_document2:
    fig_caption: yes
    toc: true
    toc_depth: 2
    number_sections: true
  bookdown::pdf_document2:
    fig_caption: yes
    keep_tex: true
---
Nejaký text z čoho pozostavala praca alebo ustredna tema? Zadanie? kto je sponzor? Kroky?
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 12, fig.height = 8)
library(tidyverse)
library(naniar)
library(styler)
library(GGally)
library(skimr)
library(ggcorrplot)
library(gridExtra)
```

```{r load, eval=TRUE, include=FALSE, cache=TRUE}
data_collection <- read.csv("..\\payment_dates_final.csv")
data_collection <- data_collection %>%
  mutate(due_date = as.Date(due_date, format = "%Y-%m-%d"))
data_collection <- data_collection %>%
  mutate(payment_date = as.Date(payment_date, format = "%Y-%m-%d"))
data_collection <- data_collection %>%
  mutate(product_type = as.factor(product_type))
data_collection <- data_collection %>%
  mutate(contract_status = as.factor(contract_status))
data_collection <- data_collection %>%
  mutate(business_discount = as.factor(business_discount))
data_collection <- data_collection %>%
  mutate(gender = as.factor(gender))
data_collection <- data_collection %>%
  mutate(marital_status = as.factor(marital_status))
data_collection <- data_collection %>%
  mutate(clients_phone = as.factor(clients_phone))
data_collection <- data_collection %>%
  mutate(client_mobile = as.factor(client_mobile))
data_collection <- data_collection %>%
  mutate(client_email = as.factor(client_email))
data_collection <- data_collection %>%
  mutate(total_earnings = factor(total_earnings, labels = c(
    "level1", "level2", "level3", "level4",
    "level5", "level6", "level7", "level8",
    "level9", "level10", "not_declared"
  )))
data_collection <- data_collection %>%
  mutate(living_area = as.factor(living_area))
data_collection <- data_collection %>%
  mutate(different_contact_area = as.factor(different_contact_area))
data_collection <- data_collection %>%
  mutate(kc_flag = as.factor(kc_flag))
data_collection <- data_collection %>%
  mutate(cf_val = as.numeric(cf_val))
data_collection <- data_collection %>%
  mutate(kzmz_flag = as.factor(kzmz_flag))
data_collection <- data_collection %>%
  mutate(due_amount = as.numeric(due_amount))
data_collection <- data_collection %>%
  mutate(paid_amount = as.numeric(payed_ammount))
data_collection <- subset(data_collection, select = -payed_ammount)
data_collection$delay <- difftime(data_collection$payment_date,
  data_collection$due_date, tz,
  units = "days")
```

```{r load_new_data, eval=TRUE, include=FALSE, cache=TRUE}
data_prepared <- read.delim("..\\data_collection_prepared_new.txt", header = TRUE, sep = ";", dec = ".")
data_prepared <- data_prepared %>%
  mutate(delay_140_y = as.factor(delay_140_y))
data_prepared <- data_prepared %>%
  mutate(delay_21_y = as.factor(delay_21_y))

```

### Basic statistics
 
Basic statistics computed for new numeric variables can be located in Table \@ref(tab:Statss).
First of all we focused on attribute *delay*, as our target attribute.
On Figure \@ref(fig:statnewdelay) 4 different plots visualizing delay variable. As we can see, the values fluctuate mostly around 0. Although values range from -1673 to 2787, its median is 17 and mean 22.13. 
  
  
We also computed some basic statistics for the other added attributes. 
Results can be seen on Figure \@ref(fig:statnew), where we visualized the distribution of delay_indiv and mean delay variables. PRIEMER????

On Figure \@ref(fig:statIndiv) we can see the distribution of variable *delay_indiv_21* and *delay_indiv_140*.We can see, that delay greater than 140 is present only in a few payments, whereas delay greater than 21 days is more common.

Lastly, we also analyzed factor variables, *delay_21_y* and *delay_140_y*. As we can see on Figure \@ref(fig:helpnew), almost half (48,2 %) of all the payments were delayed for more than 21 days.



```{r statnewdelay, echo=FALSE, eval= TRUE, message=FALSE, warning=FALSE, fig.cap="\\label{fig:stat-newdelay}Basic statistics of the added attribute delay."}
delay_plots <- list()
delay_plots[[1]] <- data_prepared %>%
  drop_na() %>%
  ggplot(aes(x = delay)) + 
  geom_histogram() + 
  xlim(-1000, 1000) +
  labs(
    title = "Distribution of delay",
    x = "Delay",
    y = "Count"
  ) +
  theme_minimal()

delay_plots[[2]] <-  data_prepared %>%
  drop_na() %>%
  ggplot(aes(x = delay)) + 
  geom_histogram() + 
  scale_y_log10() + 
  xlim(-1500, 2500) +
  labs(
    title = "Distribution of delay on logarithmic scale",
    x = "Delay",
    y = "Count"
  ) +
  theme_minimal()
delay_plots[[3]] <- data_prepared %>%
  drop_na() %>%
  ggplot(aes(delay)) +
  geom_density() +
  geom_vline(
    xintercept = mean(data_prepared$delay, na.rm = TRUE),
    color = "blue",
    linetype = "dotted", size = 1
  ) +
  geom_vline(
    xintercept = median(data_prepared$delay, na.rm = TRUE),
    color = "red",
    linetype = "dotted", size = 1
  ) +
    xlim(-400, 400) +
  labs(
    title = "Distribution of delay",
    x = "Delay",
    y = "Count"
  ) +
  annotate(
    geom = "text", x = mean(data_prepared$delay, na.rm = TRUE),
    y = 0.04, label = "mean", color = "blue"
  ) +
  annotate(
    geom = "text", x = median(data_prepared$delay, na.rm = TRUE),
    y = 0.02, label = "median", color = "red"
  ) +
  theme_minimal()

delay_plots[[4]] <- data_collection %>%
  drop_na() %>%
  ggplot() +
  geom_boxplot(aes(y = delay)) +
  scale_x_discrete() +
  labs(title = "Delay") +
  theme_minimal()
delay_plots <- grid.arrange(grobs = delay_plots, ncol = 2)
```



```{r statnew, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="\\label{fig:stat-new}Basic statistics of the added attributes."}
statistics_plots <- list()

statistics_plots[[1]] <- data_prepared %>%
  drop_na() %>%
  ggplot(aes(delay_indiv)) +
  geom_density() +
  geom_vline(
    xintercept = mean(data_prepared$delay_indiv, na.rm = TRUE),
    color = "blue",
    linetype = "dotted", size = 1
  ) +
  geom_vline(
    xintercept = median(data_prepared$delay_indiv, na.rm = TRUE),
    color = "red",
    linetype = "dotted", size = 1
  ) +
  labs(
    title = "Distribution of delay_indiv",
    x = "Delay individual",
    y = "Count"
  ) +
  annotate(
    geom = "text", x = mean(data_prepared$delay_indiv, na.rm = TRUE),
    y = 0.04, label = "mean", color = "blue"
  ) +
  annotate(
    geom = "text", x = median(data_prepared$delay_indiv, na.rm = TRUE),
    y = 0.02, label = "median", color = "red"
  ) +
  xlim(-150, 150) +
  theme_minimal()

statistics_plots[[2]] <- data_prepared %>%
  drop_na() %>%
  ggplot(aes(mean_delay_1m)) +
  geom_density() +
  geom_vline(
    xintercept = mean(data_prepared$mean_delay_1m, na.rm = TRUE),
    color = "blue",
    linetype = "dotted", size = 1
  ) +
  geom_vline(
    xintercept = median(data_prepared$mean_delay_1m, na.rm = TRUE),
    color = "red",
    linetype = "dotted", size = 1
  ) +
  labs(
    title = "Distribution of mean_delay_1m",
    x = "Mean delay of 1 month",
    y = "Count"
 ) +
  annotate(
    geom = "text", x = mean(data_prepared$mean_delay_1m, na.rm = TRUE),
    y = 0.04, label = "mean", color = "blue"
  ) +
  annotate(
    geom = "text", x = median(data_prepared$mean_delay_1m, na.rm = TRUE),
    y = 0.02, label = "median", color = "red"
  ) +
  xlim(-150, 150) +
  theme_minimal()

statistics_plots[[3]] <- data_prepared %>%
  drop_na() %>%
  ggplot(aes(mean_delay_3m)) +
  geom_density() +
  geom_vline(
    xintercept = mean(data_prepared$mean_delay_3m, na.rm = TRUE),
    color = "blue",
    linetype = "dotted", size = 1
  ) +
  geom_vline(
    xintercept = median(data_prepared$mean_delay_3m, na.rm = TRUE),
    color = "red",
    linetype = "dotted", size = 1
  ) +
  labs(
    title = "Distribution of mean_delay_3m",
    x = "Mean delay of 3 months",
    y = "Count"
 ) +
  annotate(
    geom = "text", x = mean(data_prepared$mean_delay_3m, na.rm = TRUE),
    y = 0.04, label = "mean", color = "blue"
  ) +
  annotate(
    geom = "text", x = median(data_prepared$mean_delay_3m, na.rm = TRUE),
    y = 0.02, label = "median", color = "red"
  ) +
  xlim(-150, 150) +
  theme_minimal()


statistics_plots[[4]] <- data_prepared %>%
  drop_na() %>%
  ggplot(aes(mean_delay_6m)) +
  geom_density() +
  geom_vline(
    xintercept = mean(data_prepared$mean_delay_6m, na.rm = TRUE),
    color = "blue",
    linetype = "dotted", size = 1
  ) +
  geom_vline(
    xintercept = median(data_prepared$mean_delay_6m, na.rm = TRUE),
    color = "red",
    linetype = "dotted", size = 1
  ) +
  labs(
    title = "Distribution of mean_delay_6m",
    x = "Mean delay of 6 months",
    y = "Count"
 ) +
  annotate(
    geom = "text", x = mean(data_prepared$mean_delay_6m, na.rm = TRUE),
    y = 0.04, label = "mean", color = "blue"
  ) +
  annotate(
    geom = "text", x = median(data_prepared$mean_delay_6m, na.rm = TRUE),
    y = 0.02, label = "median", color = "red"
  ) +
  xlim(-150, 150) +
  theme_minimal()


statistics_plots[[5]] <- data_prepared %>%
  drop_na() %>%
  ggplot(aes(mean_delay_12m)) +
  geom_density() +
  geom_vline(
    xintercept = mean(data_prepared$mean_delay_12m, na.rm = TRUE),
    color = "blue",
    linetype = "dotted", size = 1
  ) +
  geom_vline(
    xintercept = median(data_prepared$mean_delay_12m, na.rm = TRUE),
    color = "red",
    linetype = "dotted", size = 1
  ) +
  labs(
    title = "Distribution of mean_delay_12m",
    x = "Mean delay of 12 months",
    y = "Count"
 ) +
  annotate(
    geom = "text", x = mean(data_prepared$mean_delay_12m, na.rm = TRUE),
    y = 0.04, label = "mean", color = "blue"
  ) +
  annotate(
    geom = "text", x = median(data_prepared$mean_delay_12m, na.rm = TRUE),
    y = 0.02, label = "median", color = "red"
  ) +
  xlim(-150, 150) +
  theme_minimal()

statistics_plots <- grid.arrange(grobs = statistics_plots, ncol = 2)
```

```{r helpnew, echo=FALSE, warning=FALSE, message=FALSE, eval=TRUE, fig.cap="\\label{fig:help_new} Statistics of the factor added attributes.", out.height='70%'}
statisticss_plots <- list()

statisticss_plots[[1]] <- ggplot(data = data_prepared, aes(x = delay_21_y)) +
  geom_bar(aes(y = (..count..)/sum(..count..)))  + scale_y_continuous(labels=scales::percent) +
  geom_text(aes(y = ((..count..)/sum(..count..)), label = scales::percent((..count..)/sum(..count..))), stat = "Count", vjust = -0.25) +
  labs(title = "Payment delay greater than 21 days", y = "Percent", x = "Delay greater than 21 days")+
  theme_minimal()

statisticss_plots[[2]] <- ggplot(data = data_prepared, aes(x = delay_140_y)) +
  geom_bar(aes(y = (..count..)/sum(..count..)))  + scale_y_continuous(labels=scales::percent) +
  geom_text(aes(y = ((..count..)/sum(..count..)), label = scales::percent((..count..)/sum(..count..))), stat = "Count", vjust = -0.25) +
  labs(title = "Payment delay greater than 140 days", y = "Percent", x = "Delay greater than 140 days")+
  theme_minimal()
statisticss_plots <- grid.arrange(grobs = statisticss_plots, ncol = 2)
```

```{r statIndiv, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="\\label{fig:stat-new}Basic statistics of the added attributes.", out.height='50%'}
statistics_plots <- list()
statistics_plots[[1]] <- ggplot(data = data_prepared, aes(x = delay_indiv_21)) +
  geom_bar() +
    labs(
    title = "Distribution of delay_indiv_21",
    x = "Individual delay of 21 days",
    y = "Count"
  ) +
  theme_minimal()

statistics_plots[[2]] <- ggplot(data = data_prepared, aes(x = delay_indiv_140)) +
  geom_bar() +
  labs(
    title = "Distribution of delay_indiv_140",
    x = "Individual delay of 140 days",
    y = "Count"
  ) +
  theme_minimal()

statistics_plots <- grid.arrange(grobs = statistics_plots, ncol = 2)
```


